<!DOCTYPE html>
<html lang="en">
<head>
<title>Fox Cricket</title>

<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<meta name="referrer" content="no-referrer"/>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css"/>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.polyfilled.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  background:#000;
  overflow:hidden;
}
.plyr,
.plyr__video-wrapper,
video{
  width:100%;
  height:100%;
}

video{
  object-fit:contain;
  background:#000;
}

#recIndicator{
  position:fixed;
  top:12px;
  left:12px;
  z-index:9999;
  background:rgba(0,0,0,.75);
  color:#00ff6a;
  padding:5px 8px;
  font-size:11px;
  border-radius:4px;
  font-family:monospace;
  display:none;
}

@keyframes recBlink{
  0%{opacity:1}
  50%{opacity:.4}
  100%{opacity:1}
}

.rec-active{
  color:#00ff6a !important;
  animation:recBlink 1.2s infinite;
}
</style>
</head>

<body>

<video id="player" controls playsinline></video>
<div id="recIndicator">• REC 00:00:00</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{

const src =
  new URLSearchParams(location.search).get("url") ||
  "https://rumble.com/live-hls-dvr/6z4aec/playlist.m3u8?level=1";

const video = document.getElementById("player");
const recIndicator = document.getElementById("recIndicator");

let hls;
let recorder;
let chunks = [];
let recording = false;
let timer, startTime;
let recBtn;

function initPlyr(levels){

  const qualities = levels
    ? [...new Set(levels.map(l=>l.height))].sort((a,b)=>b-a)
    : [];

  const defaultQuality = qualities.includes(720)
    ? 720
    : qualities[0];

  const player = new Plyr(video,{
    autoplay:false,
    muted:true,        
    controls:[
      "play-large",  
      "play",
      "progress",
      "current-time",
      "mute",
      "volume",
      "settings",
      "fullscreen"
    ],
    quality: levels ? {
      default: defaultQuality,
      options: qualities,
      forced: true,
      onChange: q=>{
        levels.forEach((l,i)=>{
          if(l.height === q) hls.currentLevel = i;
        });
      }
    } : null
  });

  /* Unmute on first user play */
  player.on("play",()=>{
    video.muted = false;
    video.volume = 1;
  });
  
  recBtn = document.createElement("button");
  recBtn.className = "plyr__control";
  recBtn.innerHTML = "• REC";
  recBtn.style.fontSize = "11px";
  recBtn.style.color = "#e50914";
  recBtn.title = "Record";

  player.elements.controls.appendChild(recBtn);
  
  function format(ms){
    const t = Math.floor(ms/1000);
    const h = String(Math.floor(t/3600)).padStart(2,"0");
    const m = String(Math.floor((t%3600)/60)).padStart(2,"0");
    const s = String(t%60).padStart(2,"0");
    return `${h}:${m}:${s}`;
  }

  recBtn.onclick = ()=>{

    if(!recording){

      const stream = video.captureStream();

      recorder = new MediaRecorder(stream,{
        mimeType:"video/webm;codecs=vp9,opus",
        videoBitsPerSecond:9000000,
        audioBitsPerSecond:320000
      });

      chunks = [];

      recorder.ondataavailable = e=>{
        if(e.data.size) chunks.push(e.data);
      };

      recorder.onstop = ()=>{
        clearInterval(timer);
        recIndicator.style.display = "none";

        const blob = new Blob(chunks,{type:"video/webm"});
        const url = URL.createObjectURL(blob);

        const d = new Date();
        const fileName =
          "Sayan_Live_Stream_Recording_" +
          d.toISOString().slice(0,16)
            .replace("T","_")
            .replace(":","-") +
          ".mp4";

        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      };

      recorder.start();

      startTime = Date.now();
      recIndicator.style.display = "block";

      timer = setInterval(()=>{
        recIndicator.textContent =
          "• REC " + format(Date.now() - startTime);
      },1000);

      recBtn.classList.add("rec-active");
      recording = true;

    }else{

      recorder.stop();
      recBtn.classList.remove("rec-active");
      recording = false;
    }
  };
}

if(Hls.isSupported()){
  hls = new Hls();
  hls.loadSource(src);
  hls.attachMedia(video);
  hls.on(Hls.Events.MANIFEST_PARSED,(_,data)=>{
    initPlyr(data.levels);
  });
}else{
  video.src = src;
  initPlyr();
}

});
</script>

</body>
</html>
