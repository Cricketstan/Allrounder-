<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CricTV - Live Betting</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* RESET & BASE */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
}

html, body {
  height: 100%;
  overflow: hidden;
  background: linear-gradient(180deg, #00013a 0%, #071b4f 50%, #00013a 100%);
  color: #fff;
}

/* PARTICLE CANVAS */
#particles {
  position: fixed;
  inset: 0;
  z-index: 1;
  pointer-events: none;
}

/* HEADER */
.app-header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 100;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 15px;
  background: linear-gradient(90deg, #0b2f7c 0%, #0b2a6f 35%, #071b4f 65%, #00013a 100%);
  box-shadow: 0 4px 25px rgba(0, 0, 0, 0.5);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.back-btn {
  background: rgba(255, 255, 255, 0.1);
  border: none;
  color: white;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 18px;
  transition: all 0.2s;
}

.back-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: translateX(-2px);
}

.app-header img {
  height: 26px;
}

/* PROFILE & BALANCE */
.profile-section {
  display: flex;
  align-items: center;
  gap: 15px;
}

.balance-card {
  background: linear-gradient(145deg, #00ff88, #00cc6a);
  color: #000;
  padding: 6px 15px;
  border-radius: 20px;
  font-weight: 800;
  font-size: 14px;
  box-shadow: 0 4px 15px rgba(0, 255, 136, 0.2);
  display: flex;
  align-items: center;
  gap: 6px;
}

.profile-icon {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: linear-gradient(145deg, #4d7fff, #2a5fff);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-weight: bold;
  font-size: 16px;
  color: white;
  box-shadow: 0 4px 15px rgba(77, 127, 255, 0.3);
  transition: all 0.2s;
}

.profile-icon:hover {
  transform: scale(1.05);
}

/* MAIN CONTENT */
.main-content {
  position: relative;
  z-index: 2;
  padding-top: 60px;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

/* MATCH HEADER */
.match-header {
  padding: 15px;
  background: rgba(11, 15, 26, 0.8);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.match-title {
  font-size: 18px;
  font-weight: 800;
  margin-bottom: 5px;
  text-align: center;
}

.match-status {
  text-align: center;
  font-size: 12px;
  opacity: 0.8;
}

/* ODDS CONTAINER */
.odds-container {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
}

/* MARKET CARDS */
.market-card {
  background: linear-gradient(145deg, rgba(21, 28, 48, 0.9), rgba(15, 20, 36, 0.9));
  border-radius: 12px;
  margin-bottom: 15px;
  overflow: hidden;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.market-header {
  background: rgba(11, 15, 26, 0.9);
  padding: 12px 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.market-name {
  font-weight: 700;
  font-size: 14px;
}

.market-type {
  font-size: 11px;
  background: rgba(255, 255, 255, 0.1);
  padding: 2px 8px;
  border-radius: 10px;
}

/* RUNNER ROWS */
.runner-row {
  display: flex;
  align-items: center;
  padding: 12px 15px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  transition: background 0.2s;
}

.runner-row:last-child {
  border-bottom: none;
}

.runner-row:hover {
  background: rgba(255, 255, 255, 0.03);
}

.runner-name {
  flex: 1;
  font-size: 14px;
  font-weight: 600;
}

.odds-buttons {
  display: flex;
  gap: 8px;
}

.odds-btn {
  min-width: 70px;
  padding: 10px 12px;
  border: none;
  border-radius: 8px;
  font-weight: 800;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.odds-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.odds-btn.back {
  background: linear-gradient(145deg, #00ff88, #00cc6a);
  color: #000;
}

.odds-btn.lay {
  background: linear-gradient(145deg, #ff4d4d, #ff3333);
  color: white;
}

/* FANCY MARKETS */
.fancy-market {
  background: rgba(11, 15, 26, 0.9);
  border-radius: 12px;
  margin-bottom: 15px;
  overflow: hidden;
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.fancy-header {
  background: linear-gradient(145deg, #2a3b5f, #1a2745);
  padding: 12px 15px;
  font-weight: 700;
  font-size: 14px;
}

.fancy-row {
  display: flex;
  align-items: center;
  padding: 12px 15px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.fancy-row:last-child {
  border-bottom: none;
}

.fancy-info {
  flex: 1;
}

.fancy-name {
  font-weight: 600;
  font-size: 13px;
  margin-bottom: 2px;
}

.fancy-line {
  font-size: 11px;
  opacity: 0.8;
}

.fancy-odds {
  display: flex;
  gap: 8px;
}

.fancy-btn {
  min-width: 60px;
  padding: 8px 10px;
  border-radius: 6px;
  font-weight: 800;
  font-size: 13px;
  cursor: pointer;
  border: none;
  transition: all 0.2s;
}

.fancy-btn.back {
  background: linear-gradient(145deg, #00ff88, #00cc6a);
  color: #000;
}

.fancy-btn.lay {
  background: linear-gradient(145deg, #ff4d4d, #ff3333);
  color: white;
}

/* BET SLIP MODAL */
.bet-slip-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.9);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.bet-slip-modal.show {
  opacity: 1;
  visibility: visible;
}

.bet-slip-content {
  background: linear-gradient(145deg, #151c30, #0f1424);
  border-radius: 20px;
  width: 90%;
  max-width: 400px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.bet-slip-header {
  background: linear-gradient(145deg, #0b2f7c, #071b4f);
  padding: 20px;
  border-radius: 20px 20px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.bet-slip-header h3 {
  font-size: 18px;
  font-weight: 800;
}

.close-btn {
  background: rgba(255, 255, 255, 0.1);
  border: none;
  color: white;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 18px;
  transition: all 0.2s;
}

.close-btn:hover {
  background: rgba(255, 255, 255, 0.2);
}

.bet-details {
  padding: 20px;
}

.bet-info {
  background: rgba(11, 15, 26, 0.8);
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 20px;
}

.bet-selection {
  font-weight: 700;
  font-size: 15px;
  margin-bottom: 8px;
}

.bet-odds {
  font-size: 13px;
  opacity: 0.9;
}

.bet-amount {
  margin-bottom: 20px;
}

.bet-amount label {
  display: block;
  font-size: 13px;
  margin-bottom: 8px;
  opacity: 0.9;
}

.amount-input {
  position: relative;
}

.amount-input input {
  width: 100%;
  padding: 15px;
  background: rgba(11, 15, 26, 0.8);
  border: 2px solid rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  color: white;
  font-size: 16px;
  font-weight: 600;
  outline: none;
}

.amount-input input:focus {
  border-color: #00ff88;
}

.quick-amounts {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  flex-wrap: wrap;
}

.quick-btn {
  flex: 1;
  min-width: calc(25% - 10px);
  padding: 10px;
  background: rgba(11, 15, 26, 0.8);
  border: 2px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.quick-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: #00ff88;
}

.potential-win {
  background: rgba(0, 255, 136, 0.1);
  padding: 15px;
  border-radius: 10px;
  margin: 20px 0;
  text-align: center;
  border: 1px solid rgba(0, 255, 136, 0.2);
}

.potential-win .label {
  font-size: 13px;
  opacity: 0.9;
  margin-bottom: 5px;
}

.potential-win .amount {
  font-size: 24px;
  font-weight: 800;
  color: #00ff88;
}

.place-bet-btn {
  width: 100%;
  padding: 18px;
  background: linear-gradient(145deg, #00ff88, #00cc6a);
  border: none;
  border-radius: 12px;
  color: #000;
  font-weight: 800;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.2s;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.place-bet-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 255, 136, 0.3);
}

.place-bet-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* PROFILE MODAL */
.profile-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.9);
  z-index: 1001;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.profile-modal.show {
  opacity: 1;
  visibility: visible;
}

.profile-content {
  background: linear-gradient(145deg, #151c30, #0f1424);
  border-radius: 20px;
  width: 90%;
  max-width: 400px;
  padding: 30px;
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.profile-header {
  text-align: center;
  margin-bottom: 30px;
}

.profile-header h3 {
  font-size: 22px;
  font-weight: 800;
  margin-bottom: 10px;
}

.profile-balance {
  text-align: center;
  margin-bottom: 30px;
}

.balance-amount {
  font-size: 36px;
  font-weight: 800;
  color: #00ff88;
  margin-bottom: 5px;
}

.balance-label {
  font-size: 13px;
  opacity: 0.8;
}

.profile-stats {
  background: rgba(11, 15, 26, 0.8);
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
}

.stat-row {
  display: flex;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.stat-row:last-child {
  border-bottom: none;
}

.stat-label {
  font-size: 13px;
  opacity: 0.8;
}

.stat-value {
  font-weight: 600;
}

.win {
  color: #00ff88;
}

.lose {
  color: #ff4d4d;
}

/* SCROLLBAR */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* LOADING */
.loading {
  text-align: center;
  padding: 40px;
  opacity: 0.8;
}

/* EMPTY STATE */
.empty-state {
  text-align: center;
  padding: 40px;
  opacity: 0.6;
}
</style>
</head>

<body>

<canvas id="particles"></canvas>

<header class="app-header">
  <div class="header-left">
    <button class="back-btn" onclick="goBack()">‚Üê</button>
    <img src="https://crickettv.site/image/api/crickettv.png" alt="CricTV">
  </div>
  
  <div class="profile-section">
    <div class="balance-card" id="userBalance">‚Çπ0</div>
    <div class="profile-icon" onclick="openProfile()">üë§</div>
  </div>
</header>

<div class="main-content">
  <div class="match-header">
    <div class="match-title" id="matchTitle">Loading...</div>
    <div class="match-status" id="matchStatus">‚Ä¢ Loading market data</div>
  </div>
  
  <div class="odds-container" id="oddsContainer">
    <div class="loading">Loading markets...</div>
  </div>
</div>

<!-- BET SLIP MODAL -->
<div class="bet-slip-modal" id="betSlipModal">
  <div class="bet-slip-content">
    <div class="bet-slip-header">
      <h3>Place Bet</h3>
      <button class="close-btn" onclick="closeBetSlip()">√ó</button>
    </div>
    
    <div class="bet-details">
      <div class="bet-info">
        <div class="bet-selection" id="betSelection">Select a market</div>
        <div class="bet-odds" id="betOdds">Odds: -</div>
      </div>
      
      <div class="bet-amount">
        <label>Stake Amount (‚Çπ)</label>
        <div class="amount-input">
          <input type="number" id="betAmount" placeholder="Enter amount" min="10" max="1000000">
        </div>
        
        <div class="quick-amounts">
          <button class="quick-btn" onclick="setAmount(100)">‚Çπ100</button>
          <button class="quick-btn" onclick="setAmount(500)">‚Çπ500</button>
          <button class="quick-btn" onclick="setAmount(1000)">‚Çπ1K</button>
          <button class="quick-btn" onclick="setAmount(5000)">‚Çπ5K</button>
          <button class="quick-btn" onclick="setAmount(10000)">‚Çπ10K</button>
        </div>
      </div>
      
      <div class="potential-win">
        <div class="label">Potential Win</div>
        <div class="amount" id="potentialWin">‚Çπ0</div>
      </div>
      
      <button class="place-bet-btn" id="placeBetBtn" onclick="placeBet()">Place Bet</button>
    </div>
  </div>
</div>

<!-- PROFILE MODAL -->
<div class="profile-modal" id="profileModal">
  <div class="profile-content">
    <div class="profile-header">
      <h3>My Account</h3>
      <div>Welcome to CricTV Betting</div>
    </div>
    
    <div class="profile-balance">
      <div class="balance-amount" id="profileBalance">‚Çπ0</div>
      <div class="balance-label">Available Balance</div>
    </div>
    
    <div class="profile-stats" id="profileStats">
      <div class="stat-row">
        <span class="stat-label">Total Bets</span>
        <span class="stat-value" id="totalBets">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Winning Bets</span>
        <span class="stat-value win" id="winningBets">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Losing Bets</span>
        <span class="stat-value lose" id="losingBets">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Net Profit</span>
        <span class="stat-value win" id="netProfit">‚Çπ0</span>
      </div>
    </div>
    
    <button class="place-bet-btn" onclick="closeProfile()" style="background: linear-gradient(145deg, #4d7fff, #2a5fff);">Close</button>
  </div>
</div>

<script>
// ==================== SYSTEM INITIALIZATION ====================
let userProfile = null;
let currentBet = null;
let matchData = null;
const EVENT_ID = new URLSearchParams(location.search).get("eventId");

// Particle System (Same as main page)
const canvas = document.getElementById('particles');
const ctx = canvas.getContext('2d');
let w, h;

function resizeCanvas() {
  w = canvas.width = window.innerWidth;
  h = canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

const particles = [];
const COUNT = 45;

for (let i = 0; i < COUNT; i++) {
  particles.push({
    x: Math.random() * w,
    y: Math.random() * h,
    r: Math.random() * 1.4 + 0.4,
    vx: Math.random() * 0.15 + 0.05,
    vy: Math.random() * 0.1 + 0.03,
    a: Math.random() * 0.35 + 0.15
  });
}

function animateParticles() {
  ctx.clearRect(0, 0, w, h);
  
  for (const p of particles) {
    p.x += p.vx;
    p.y += p.vy;
    
    if (p.x > w) p.x = 0;
    if (p.y > h) p.y = 0;
    
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(255, 255, 255, ${p.a})`;
    ctx.fill();
  }
  
  requestAnimationFrame(animateParticles);
}
animateParticles();

// ==================== USER PROFILE SYSTEM ====================
function loadUserProfile() {
  const saved = localStorage.getItem('cricTV_user');
  if (saved) {
    userProfile = JSON.parse(saved);
    updateBalanceDisplay();
    return true;
  }
  return false;
}

function createUserProfile() {
  if (!userProfile) {
    userProfile = {
      id: Date.now(),
      name: 'Player',
      balance: 10000,
      createdAt: new Date().toISOString(),
      bets: [],
      stats: {
        totalBets: 0,
        winningBets: 0,
        losingBets: 0,
        netProfit: 0
      }
    };
    localStorage.setItem('cricTV_user', JSON.stringify(userProfile));
    updateBalanceDisplay();
  }
}

function updateBalanceDisplay() {
  if (userProfile) {
    document.getElementById('userBalance').textContent = `‚Çπ${userProfile.balance.toLocaleString()}`;
  }
}

// ==================== BETTING SYSTEM ====================
function openBetSlip(betType, marketId, runnerId, runnerName, odds, marketName, marketType = 'match') {
  if (!userProfile) {
    alert('Please wait, creating your account...');
    createUserProfile();
    return;
  }
  
  currentBet = {
    type: betType,
    marketId,
    runnerId,
    runnerName,
    odds: parseFloat(odds),
    marketName,
    marketType,
    eventId: EVENT_ID,
    eventName: document.getElementById('matchTitle').textContent,
    timestamp: new Date().toISOString()
  };
  
  const betSlip = document.getElementById('betSlipModal');
  const selection = document.getElementById('betSelection');
  const oddsDisplay = document.getElementById('betOdds');
  
  const typeColor = betType === 'back' ? '#00ff88' : '#ff4d4d';
  const typeText = betType === 'back' ? 'BACK' : 'LAY';
  
  selection.innerHTML = `<span style="color:${typeColor}">${typeText}</span> ${runnerName}`;
  oddsDisplay.textContent = `Odds: ${odds} ‚Ä¢ Market: ${marketName}`;
  document.getElementById('betAmount').value = '';
  document.getElementById('potentialWin').textContent = '‚Çπ0';
  
  betSlip.classList.add('show');
  document.getElementById('betAmount').focus();
}

function closeBetSlip() {
  document.getElementById('betSlipModal').classList.remove('show');
  currentBet = null;
}

function setAmount(amount) {
  if (!userProfile) return;
  
  if (amount > userProfile.balance) {
    alert(`Insufficient balance. Available: ‚Çπ${userProfile.balance.toLocaleString()}`);
    return;
  }
  
  const input = document.getElementById('betAmount');
  input.value = amount;
  calculatePotentialWin();
}

function calculatePotentialWin() {
  const amount = parseFloat(document.getElementById('betAmount').value) || 0;
  if (!currentBet || amount === 0) {
    document.getElementById('potentialWin').textContent = '‚Çπ0';
    return;
  }
  
  let potentialWin = 0;
  if (currentBet.type === 'back') {
    potentialWin = (amount * currentBet.odds) - amount;
  } else { // lay
    potentialWin = amount * (currentBet.odds - 1);
  }
  
  document.getElementById('potentialWin').textContent = `‚Çπ${Math.round(potentialWin).toLocaleString()}`;
}

function placeBet() {
  if (!userProfile || !currentBet) return;
  
  const amount = parseFloat(document.getElementById('betAmount').value);
  if (!amount || amount < 10) {
    alert('Minimum bet amount is ‚Çπ10');
    return;
  }
  
  if (amount > userProfile.balance) {
    alert(`Insufficient balance. Available: ‚Çπ${userProfile.balance.toLocaleString()}`);
    return;
  }
  
  // Calculate potential win
  let potentialWin = 0;
  if (currentBet.type === 'back') {
    potentialWin = (amount * currentBet.odds) - amount;
  } else {
    potentialWin = amount * (currentBet.odds - 1);
  }
  
  // Create bet record
  const betRecord = {
    id: Date.now(),
    ...currentBet,
    stake: amount,
    potentialWin: Math.round(potentialWin),
    placedAt: new Date().toISOString(),
    settled: false,
    result: null,
    winnings: null
  };
  
  // Update user profile
  userProfile.balance -= amount;
  userProfile.bets.push(betRecord);
  userProfile.stats.totalBets++;
  
  // Save to localStorage
  localStorage.setItem('cricTV_user', JSON.stringify(userProfile));
  
  // Update UI
  updateBalanceDisplay();
  
  // Show success message
  alert(`‚úÖ Bet placed successfully!\n\nStake: ‚Çπ${amount.toLocaleString()}\nPotential Win: ‚Çπ${Math.round(potentialWin).toLocaleString()}\nGood luck!`);
  
  // Close bet slip
  closeBetSlip();
}

// ==================== PROFILE SYSTEM ====================
function openProfile() {
  if (!userProfile) {
    createUserProfile();
  }
  
  const modal = document.getElementById('profileModal');
  const stats = userProfile.stats;
  
  document.getElementById('profileBalance').textContent = `‚Çπ${userProfile.balance.toLocaleString()}`;
  document.getElementById('totalBets').textContent = stats.totalBets;
  document.getElementById('winningBets').textContent = stats.winningBets;
  document.getElementById('losingBets').textContent = stats.losingBets;
  document.getElementById('netProfit').textContent = `‚Çπ${stats.netProfit.toLocaleString()}`;
  
  modal.classList.add('show');
}

function closeProfile() {
  document.getElementById('profileModal').classList.remove('show');
}

// ==================== NAVIGATION ====================
function goBack() {
  location.href = 'index.html';
}

// ==================== MATCH DATA ====================
async function loadMatchData() {
  try {
    const API = `https://central.zplay1.in/pb/api/v1/events/matchDetails/${EVENT_ID}`;
    const response = await fetch(API);
    const data = await response.json();
    
    if (!data.data || !data.data.match) {
      throw new Error('Invalid match data');
    }
    
    matchData = data.data.match;
    renderMatchData();
  } catch (error) {
    console.error('Error loading match:', error);
    document.getElementById('oddsContainer').innerHTML = `
      <div class="empty-state">
        Failed to load match data. Please try again.
      </div>
    `;
  }
}

function renderMatchData() {
  // Update match header
  document.getElementById('matchTitle').textContent = matchData.eventName;
  document.getElementById('matchStatus').textContent = '‚Ä¢ Live betting available';
  
  const container = document.getElementById('oddsContainer');
  let html = '';
  
  // Match Odds Markets
  if (matchData.matchOddData && matchData.matchOddData.length > 0) {
    matchData.matchOddData.forEach(market => {
      let runnersHtml = '';
      
      market.runners?.forEach(runner => {
        const backOdds = getBestBackOdds(runner);
        const layOdds = getBestLayOdds(runner);
        
        if (!backOdds && !layOdds) return;
        
        const runnerName = market.runnerName?.find(r => r.SID === runner.sid)?.RN || 'Team';
        
        runnersHtml += `
          <div class="runner-row">
            <div class="runner-name">${runnerName}</div>
            <div class="odds-buttons">
              ${backOdds ? `
                <button class="odds-btn back" onclick="openBetSlip('back', '${market.mid}', '${runner.sid}', '${runnerName}', '${backOdds}', '${market.marketName}')">
                  ${backOdds}
                </button>
              ` : ''}
              ${layOdds ? `
                <button class="odds-btn lay" onclick="openBetSlip('lay', '${market.mid}', '${runner.sid}', '${runnerName}', '${layOdds}', '${market.marketName}')">
                  ${layOdds}
                </button>
              ` : ''}
            </div>
          </div>
        `;
      });
      
      if (runnersHtml) {
        html += `
          <div class="market-card">
            <div class="market-header">
              <div class="market-name">${market.marketName}</div>
              <div class="market-type">MATCH ODDS</div>
            </div>
            ${runnersHtml}
          </div>
        `;
      }
    });
  }
  
  // Fancy Markets
  if (matchData.fancyOddData?.ml && matchData.fancyOddData.ml.length > 0) {
    html += `<div class="fancy-header" style="margin-bottom: 10px;">Fancy Markets</div>`;
    
    matchData.fancyOddData.ml.forEach(fancy => {
      html += `
        <div class="fancy-market">
          <div class="fancy-row">
            <div class="fancy-info">
              <div class="fancy-name">${fancy.mn}</div>
              <div class="fancy-line">${fancy.rn} - ${fancy.ry}</div>
            </div>
            <div class="fancy-odds">
              <button class="fancy-btn back" onclick="openBetSlip('back', 'fancy_${fancy.id}', 'yes', '${fancy.mn} - YES', '${fancy.oy}', 'Fancy Market', 'fancy')">
                ${fancy.oy}
              </button>
              <button class="fancy-btn lay" onclick="openBetSlip('lay', 'fancy_${fancy.id}', 'no', '${fancy.mn} - NO', '${fancy.on}', 'Fancy Market', 'fancy')">
                ${fancy.on}
              </button>
            </div>
          </div>
        </div>
      `;
    });
  }
  
  if (!html) {
    html = `<div class="empty-state">No betting markets available at the moment.</div>`;
  }
  
  container.innerHTML = html;
}

function getBestBackOdds(runner) {
  return runner.ex?.b?.length ? Math.max(...runner.ex.b.map(o => o.p)) : null;
}

function getBestLayOdds(runner) {
  return runner.ex?.l?.length ? Math.min(...runner.ex.l.map(o => o.p)) : null;
}

// ==================== AUTO SETTLEMENT ====================
function checkAndSettleBets() {
  if (!userProfile || !matchData) return;
  
  let updated = false;
  
  // Check if match has ended and settle bets
  matchData.matchOddData?.forEach(market => {
    market.runners?.forEach(runner => {
      if (runner.s === "WINNER") {
        // Match ended, settle all bets
        userProfile.bets.forEach(bet => {
          if (bet.eventId == EVENT_ID && !bet.settled) {
            bet.settled = true;
            
            if (bet.runnerId == runner.sid) {
              // Winning bet
              if (bet.type === 'back') {
                const winnings = bet.stake * bet.odds;
                userProfile.balance += winnings;
                bet.result = 'WIN';
                bet.winnings = winnings;
                userProfile.stats.winningBets++;
                userProfile.stats.netProfit += (winnings - bet.stake);
              } else {
                // Losing lay bet
                bet.result = 'LOSE';
                userProfile.stats.losingBets++;
                userProfile.stats.netProfit -= (bet.stake * (bet.odds - 1));
              }
            } else {
              // Losing bet
              if (bet.type === 'back') {
                bet.result = 'LOSE';
                userProfile.stats.losingBets++;
                userProfile.stats.netProfit -= bet.stake;
              } else {
                // Winning lay bet
                const winnings = bet.stake;
                userProfile.balance += winnings;
                bet.result = 'WIN';
                bet.winnings = winnings;
                userProfile.stats.winningBets++;
                userProfile.stats.netProfit += winnings;
              }
            }
            
            updated = true;
          }
        });
      }
    });
  });
  
  if (updated) {
    localStorage.setItem('cricTV_user', JSON.stringify(userProfile));
    updateBalanceDisplay();
  }
}

// ==================== INITIALIZATION ====================
// Initialize user profile
if (!loadUserProfile()) {
  createUserProfile();
}

// Load match data
loadMatchData();

// Set up auto settlement check
setInterval(checkAndSettleBets, 5000);

// Set up bet amount listener
document.getElementById('betAmount').addEventListener('input', calculatePotentialWin);
</script>
</body>
</html>