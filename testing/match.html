<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Match Odds</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui}
body{background:#0b0f1a;color:#fff;padding:14px}

h2{margin-bottom:10px}
.section-title{
  margin:18px 0 10px;
  font-size:16px;
  font-weight:800;
  opacity:.9;
}

/* User Balance */
.user-balance {
  position: fixed;
  top: 10px;
  right: 10px;
  background: linear-gradient(145deg, #00ff88, #00cc6a);
  color: #000;
  padding: 8px 15px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 14px;
  z-index: 100;
  box-shadow: 0 4px 15px rgba(0,255,136,0.3);
}

/* Back Button */
.back-btn {
  position: fixed;
  top: 10px;
  left: 10px;
  background: #2a3b5f;
  color: #fff;
  padding: 8px 15px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 14px;
  z-index: 100;
  text-decoration: none;
  cursor: pointer;
}

/* Bet Slip */
.bet-slip {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(145deg,#151c30,#0f1424);
  border-radius: 20px 20px 0 0;
  padding: 20px;
  box-shadow: 0 -5px 25px rgba(0,0,0,0.5);
  z-index: 1000;
  display: none;
}

.bet-slip.show {
  display: block;
}

.bet-slip-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.close-bet-slip {
  background: #ff4d4d;
  color: white;
  border: none;
  padding: 8px 15px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: bold;
}

.bet-details {
  background: #0e1527;
  padding: 15px;
  border-radius: 10px;
  margin-bottom: 15px;
}

.bet-input-group {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 10px;
}

.bet-input-group input {
  flex: 1;
  padding: 12px;
  border-radius: 10px;
  border: 2px solid #2a3b5f;
  background: #0a0f1d;
  color: #fff;
  font-size: 16px;
}

.bet-quick-amounts {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

.bet-quick-amounts button {
  flex: 1;
  padding: 8px;
  border-radius: 8px;
  border: 2px solid #2a3b5f;
  background: #0e1527;
  color: #fff;
  cursor: pointer;
}

.bet-quick-amounts button:hover {
  background: #2a3b5f;
}

.place-bet-btn {
  width: 100%;
  padding: 15px;
  border-radius: 10px;
  border: none;
  background: linear-gradient(145deg, #00ff88, #00cc6a);
  color: #000;
  font-weight: bold;
  font-size: 16px;
  cursor: pointer;
  margin-top: 15px;
}

.market{
  background:linear-gradient(145deg,#151c30,#0f1424);
  border-radius:16px;
  padding:14px;
  margin-bottom:14px;
}

.market-name{
  font-weight:800;
  margin-bottom:10px;
}

.runner, .fancy-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:8px 0;
  cursor: pointer;
  transition: all 0.2s;
}

.runner:hover, .fancy-row:hover {
  transform: translateY(-2px);
}

.odds span{
  padding:8px 12px;
  border-radius:8px;
  font-weight:800;
  margin-left:6px;
  cursor: pointer;
  min-width: 70px;
  text-align: center;
  display: inline-block;
}

.odds span:hover {
  opacity: 0.9;
  transform: scale(1.05);
}

.back{background:#00ff88;color:#000}
.lay{background:#ff4d4d}

.fancy-box{
  background:#0e1527;
  padding:10px 12px;
  border-radius:12px;
  margin-bottom:8px;
}

.fancy-name{
  font-size:14px;
  font-weight:700;
  margin-bottom:6px;
}

.fancy-line{
  font-size:13px;
  opacity:.8;
}

.badge{
  font-size:11px;
  padding:3px 8px;
  border-radius:20px;
  font-weight:700;
}
.online{background:#00ff88;color:#000}
.suspend{background:#ffb020;color:#000}

/* Stakes display */
.stakes-display {
  margin-top: 20px;
  background: #0e1527;
  padding: 15px;
  border-radius: 10px;
}

.stakes-display h3 {
  margin-bottom: 10px;
  font-size: 16px;
}

.stake-item {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid #2a3b5f;
}

.stake-item:last-child {
  border-bottom: none;
}

/* Odds Info */
.odds-info {
  font-size: 12px;
  opacity: 0.7;
  margin-top: 20px;
  text-align: center;
}
</style>
</head>

<body>

<!-- Back Button -->
<div class="back-btn" onclick="goBack()">← Back</div>

<!-- User Balance -->
<div class="user-balance" id="userBalance">₹0</div>

<h2 id="title">Loading…</h2>

<!-- MATCH ODDS -->
<div id="matchOdds"></div>

<!-- FANCY ODDS -->
<div class="section-title">Fancy / Session Markets</div>
<div id="fancyOdds"></div>

<!-- My Stakes -->
<div class="stakes-display">
  <h3>My Stakes (This Match)</h3>
  <div id="myStakes"></div>
</div>

<!-- Bet Slip -->
<div class="bet-slip" id="betSlip">
  <div class="bet-slip-header">
    <h3>Place Bet</h3>
    <button class="close-bet-slip" onclick="closeBetSlip()">✕</button>
  </div>
  
  <div class="bet-details">
    <div id="betSelection">Select bet type</div>
    <div id="betOdds">Odds: -</div>
    <div id="betMarket">Market: -</div>
    
    <div class="bet-input-group">
      <input type="number" id="betAmount" placeholder="Enter stake amount" min="10" max="100000">
      <div>₹</div>
    </div>
    
    <div class="bet-quick-amounts">
      <button onclick="setAmount(100)">100</button>
      <button onclick="setAmount(500)">500</button>
      <button onclick="setAmount(1000)">1K</button>
      <button onclick="setAmount(5000)">5K</button>
    </div>
    
    <div style="margin-top: 10px;">
      <div>Potential Win: <span id="potentialWin">₹0</span></div>
    </div>
  </div>
  
  <button class="place-bet-btn" onclick="placeBet()">Place Bet</button>
</div>

<script>
// User profile
let userProfile = null;
let currentBet = null;
let matchData = null;
const EVENT_ID = new URLSearchParams(location.search).get("eventId");

// Load user profile
function loadProfile() {
  const saved = localStorage.getItem('cricket_user');
  if (saved) {
    userProfile = JSON.parse(saved);
    updateBalanceDisplay();
    loadUserStakes();
    return true;
  }
  return false;
}

// Update balance display
function updateBalanceDisplay() {
  if (userProfile) {
    document.getElementById('userBalance').textContent = `₹${userProfile.balance.toLocaleString()}`;
  }
}

// Load user stakes for this match
function loadUserStakes() {
  if (!userProfile || !userProfile.bets) return;
  
  const stakesDiv = document.getElementById('myStakes');
  stakesDiv.innerHTML = '';
  
  const matchBets = userProfile.bets.filter(bet => 
    bet.eventId == EVENT_ID && !bet.settled
  );
  
  if (matchBets.length === 0) {
    stakesDiv.innerHTML = '<div>No active bets</div>';
    return;
  }
  
  matchBets.forEach(bet => {
    const stakeItem = document.createElement('div');
    stakeItem.className = 'stake-item';
    
    const betType = bet.type === 'back' ? 'Back' : 'Lay';
    const color = bet.type === 'back' ? '#00ff88' : '#ff4d4d';
    
    stakeItem.innerHTML = `
      <div>
        <strong style="color:${color}">${betType}</strong><br>
        ${bet.runnerName} @ ${bet.odds}
      </div>
      <div>
        ₹${bet.stake.toLocaleString()}<br>
        <small>Win: ₹${bet.potentialWin.toLocaleString()}</small>
      </div>
    `;
    
    stakesDiv.appendChild(stakeItem);
  });
}

// Go back to main page
function goBack() {
  location.href = 'index.html';
}

// Open bet slip
function openBetSlip(betType, marketId, runnerId, runnerName, odds, marketName, marketType = 'match') {
  if (!userProfile) {
    alert('Please create an account first on the main page');
    return;
  }
  
  currentBet = {
    type: betType,
    marketId,
    runnerId,
    runnerName,
    odds: parseFloat(odds),
    marketName,
    marketType,
    eventId: EVENT_ID,
    eventName: document.getElementById('title').innerText
  };
  
  const betSlip = document.getElementById('betSlip');
  document.getElementById('betSelection').innerHTML = `
    <strong style="color:${betType === 'back' ? '#00ff88' : '#ff4d4d'}">
      ${betType === 'back' ? 'Back' : 'Lay'}
    </strong> ${runnerName}
  `;
  document.getElementById('betOdds').textContent = `Odds: ${odds}`;
  document.getElementById('betMarket').textContent = `Market: ${marketName}`;
  document.getElementById('betAmount').value = '';
  document.getElementById('potentialWin').textContent = '₹0';
  
  betSlip.classList.add('show');
  
  // Update potential win on amount change
  document.getElementById('betAmount').addEventListener('input', updatePotentialWin);
}

// Close bet slip
function closeBetSlip() {
  document.getElementById('betSlip').classList.remove('show');
  currentBet = null;
}

// Set quick amount
function setAmount(amount) {
  if (!userProfile) {
    alert('Please create an account first');
    return;
  }
  
  if (amount > userProfile.balance) {
    alert('Insufficient balance');
    return;
  }
  
  document.getElementById('betAmount').value = amount;
  updatePotentialWin();
}

// Update potential win calculation
function updatePotentialWin() {
  const amount = parseFloat(document.getElementById('betAmount').value) || 0;
  if (!currentBet || amount === 0) {
    document.getElementById('potentialWin').textContent = '₹0';
    return;
  }
  
  let potentialWin = 0;
  if (currentBet.type === 'back') {
    potentialWin = amount * (currentBet.odds - 1);
  } else { // lay
    potentialWin = amount;
  }
  
  document.getElementById('potentialWin').textContent = `₹${potentialWin.toLocaleString()}`;
}

// Place bet
function placeBet() {
  if (!userProfile || !currentBet) return;
  
  const amount = parseFloat(document.getElementById('betAmount').value);
  if (!amount || amount < 10) {
    alert('Minimum bet amount is ₹10');
    return;
  }
  
  if (amount > userProfile.balance) {
    alert('Insufficient balance');
    return;
  }
  
  // Calculate potential win
  let potentialWin = 0;
  if (currentBet.type === 'back') {
    potentialWin = amount * (currentBet.odds - 1);
  } else {
    potentialWin = amount;
  }
  
  // Create bet object
  const bet = {
    id: Date.now(),
    type: currentBet.type,
    marketId: currentBet.marketId,
    runnerId: currentBet.runnerId,
    runnerName: currentBet.runnerName,
    odds: currentBet.odds,
    marketName: currentBet.marketName,
    marketType: currentBet.marketType,
    eventId: currentBet.eventId,
    eventName: currentBet.eventName,
    stake: amount,
    potentialWin: potentialWin,
    placedAt: new Date().toISOString(),
    settled: false,
    result: null
  };
  
  // Update user balance and bets
  userProfile.balance -= amount;
  if (!userProfile.bets) userProfile.bets = [];
  userProfile.bets.push(bet);
  
  // Save to localStorage
  localStorage.setItem('cricket_user', JSON.stringify(userProfile));
  
  // Update UI
  updateBalanceDisplay();
  loadUserStakes();
  
  // Show success message
  alert(`Bet placed successfully!\nStake: ₹${amount}\nPotential Win: ₹${potentialWin}`);
  
  // Close bet slip
  closeBetSlip();
}

// Auto-settle bets when match ends
function autoSettleBets(winningRunnerId) {
  if (!userProfile || !userProfile.bets) return;
  
  let updated = false;
  
  userProfile.bets.forEach(bet => {
    if (bet.eventId == EVENT_ID && !bet.settled) {
      bet.settled = true;
      
      if (bet.runnerId == winningRunnerId) {
        // User backed/layed the winner
        if (bet.type === 'back') {
          const winnings = bet.stake * bet.odds;
          userProfile.balance += winnings;
          bet.result = `WON: ₹${winnings.toLocaleString()}`;
        } else {
          // Lay bet on winner (user loses)
          const liability = bet.stake * (bet.odds - 1);
          bet.result = `LOST: ₹${liability.toLocaleString()}`;
        }
      } else {
        // User backed/layed the loser
        if (bet.type === 'back') {
          bet.result = `LOST: ₹${bet.stake.toLocaleString()}`;
        } else {
          // Lay bet on loser (user wins)
          userProfile.balance += bet.stake;
          bet.result = `WON: ₹${bet.stake.toLocaleString()}`;
        }
      }
      
      updated = true;
    }
  });
  
  if (updated) {
    localStorage.setItem('cricket_user', JSON.stringify(userProfile));
    updateBalanceDisplay();
    loadUserStakes();
  }
}

// Load profile on page load
if (!loadProfile()) {
  alert('Please create an account on the main page first');
  setTimeout(() => {
    location.href = 'index.html';
  }, 2000);
}

/* ==================== API FETCH ==================== */
const API = "https://central.zplay1.in/pb/api/v1/events/matchDetails/" + EVENT_ID;

function bestBack(r){
  return r.ex?.b?.length ? Math.max(...r.ex.b.map(o=>o.p)) : null;
}
function bestLay(r){
  return r.ex?.l?.length ? Math.min(...r.ex.l.map(o=>o.p)) : null;
}

fetch(API)
.then(r=>r.json())
.then(d=>{
  const match = d.data.match;
  document.getElementById("title").innerText = match.eventName;
  
  // Save match data for later
  matchData = match;

  /* ================= MATCH ODDS ================= */
  const matchBox = document.getElementById("matchOdds");
  match.matchOddData.forEach(market=>{
    let html="";

    market.runners.forEach(r=>{
      const back = bestBack(r);
      const lay  = bestLay(r);
      if(!back && !lay) return;

      const name =
        market.runnerName?.find(x=>x.SID===r.sid)?.RN || "Runner";

      html += `
        <div class="runner">
          <div>${name}</div>
          <div class="odds">
            ${back?`<span class="back" onclick="openBetSlip('back', '${market.mid}', '${r.sid}', '${name}', '${back}', '${market.marketName}')">${back}</span>`:""}
            ${lay?`<span class="lay" onclick="openBetSlip('lay', '${market.mid}', '${r.sid}', '${name}', '${lay}', '${market.marketName}')">${lay}</span>`:""}
          </div>
        </div>
      `;
    });

    if(html){
      matchBox.innerHTML += `
        <div class="market">
          <div class="market-name">${market.marketName}</div>
          ${html}
        </div>
      `;
    }
  });

  /* ================= FANCY ODDS ================= */
  const fancyBox = document.getElementById("fancyOdds");
  const fancyList = match.fancyOddData?.ml || [];

  fancyList.forEach(f=>{
    fancyBox.innerHTML += `
      <div class="fancy-box">
        <div class="fancy-name">
          ${f.mn}
          <span class="badge ${f.sn === "ONLINE" ? "online":"suspend"}">
            ${f.sn}
          </span>
        </div>

        <div class="fancy-row">
          <div class="fancy-line">
            Line: ${f.rn} – ${f.ry}
          </div>
          <div class="odds">
            <span class="back" onclick="openBetSlip('back', 'fancy_${f.id}', 'yes', '${f.mn} - Yes', '${f.oy}', 'Fancy Market', 'fancy')">${f.oy}</span>
            <span class="lay" onclick="openBetSlip('lay', 'fancy_${f.id}', 'no', '${f.mn} - No', '${f.on}', 'Fancy Market', 'fancy')">${f.on}</span>
          </div>
        </div>
      </div>
    `;
  });
  
  // Check if match has ended and settle bets
  checkMatchEnd();
})
.catch(e=>{
  console.error("Failed to load match:", e);
  document.getElementById("title").innerText = "Failed to load match";
});

// Check if match has ended
function checkMatchEnd() {
  if (!matchData) return;
  
  // Check runners for WINNER status
  matchData.matchOddData?.forEach(market => {
    market.runners?.forEach(runner => {
      if (runner.s === "WINNER") {
        autoSettleBets(runner.sid);
      }
    });
  });
}

// Odds information
document.body.innerHTML += `
<div class="odds-info">
  <strong>How Betting Works:</strong><br>
  <strong style="color:#00ff88">Back</strong> = Betting for a team to win<br>
  <strong style="color:#ff4d4d">Lay</strong> = Betting against a team (they won't win)<br>
  Example: Back @ 1.85 with ₹100 = Win ₹85 (₹185 total return)
</div>`;
</script>
</body>
</html>
