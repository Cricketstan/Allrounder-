<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CricTV - Betting</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: system-ui, -apple-system, sans-serif;
}

html, body {
  height: 100%;
  overflow: hidden;
  background: linear-gradient(180deg, #00013a 0%, #071b4f 50%, #00013a 100%);
  color: #fff;
}

/* Particles */
#particles {
  position: fixed;
  inset: 0;
  z-index: 1;
  pointer-events: none;
}

/* Header */
.app-header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 100;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 15px;
  background: linear-gradient(90deg, #0b2f7c 0%, #0b2a6f 35%, #071b4f 65%, #00013a 100%);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.logo {
  height: 30px;
}

.user-section {
  display: flex;
  align-items: center;
  gap: 15px;
}

.balance-display {
  background: linear-gradient(145deg, #00ff88, #00cc6a);
  color: #000;
  padding: 6px 12px;
  border-radius: 20px;
  font-weight: 800;
  font-size: 14px;
}

.profile-icon {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: linear-gradient(145deg, #4d7fff, #2a5fff);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-weight: bold;
  font-size: 16px;
}

/* Main Content */
.main-content {
  position: relative;
  z-index: 2;
  padding-top: 60px;
  height: 100vh;
  overflow-y: auto;
}

/* Matches Section */
.matches-section {
  padding: 15px;
}

.match-card {
  background: linear-gradient(145deg, #151c30, #0f1424);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 15px;
  cursor: pointer;
  transition: all 0.2s;
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.match-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
  border-color: rgba(255, 255, 255, 0.1);
}

.league-info {
  font-size: 12px;
  opacity: 0.8;
  margin-bottom: 8px;
}

.match-name {
  font-size: 16px;
  font-weight: 800;
  margin-bottom: 12px;
}

.runner-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  background: rgba(11, 15, 26, 0.8);
  border-radius: 8px;
  margin-bottom: 8px;
}

.runner-name {
  font-size: 14px;
  font-weight: 600;
}

.odds-display {
  display: flex;
  gap: 8px;
}

.odds-btn {
  min-width: 60px;
  padding: 8px 10px;
  border-radius: 6px;
  font-weight: 800;
  font-size: 13px;
}

.back-odds {
  background: #00ff88;
  color: #000;
}

.lay-odds {
  background: #ff4d4d;
  color: white;
}

.status-badge {
  font-size: 11px;
  padding: 3px 8px;
  border-radius: 10px;
  font-weight: 700;
  margin-top: 8px;
  display: inline-block;
}

.status-live {
  background: rgba(255, 77, 77, 0.2);
  color: #ff4d4d;
}

.status-upcoming {
  background: rgba(255, 170, 0, 0.2);
  color: #ffaa00;
}

/* Profile Modal */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.9);
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
}

.modal-overlay.show {
  display: flex;
}

.modal-content {
  background: linear-gradient(145deg, #151c30, #0f1424);
  border-radius: 20px;
  padding: 25px;
  width: 90%;
  max-width: 400px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-title {
  font-size: 20px;
  font-weight: 800;
  margin-bottom: 20px;
  text-align: center;
  color: #00ff88;
}

.balance-show {
  text-align: center;
  margin-bottom: 25px;
}

.balance-amount {
  font-size: 36px;
  font-weight: 900;
  color: #00ff88;
  margin-bottom: 5px;
}

.balance-label {
  font-size: 14px;
  opacity: 0.8;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
  margin-bottom: 25px;
}

.stat-card {
  background: rgba(11, 15, 26, 0.8);
  padding: 15px;
  border-radius: 10px;
  text-align: center;
}

.stat-value {
  font-size: 20px;
  font-weight: 800;
  margin-bottom: 5px;
}

.stat-label {
  font-size: 12px;
  opacity: 0.7;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  font-size: 13px;
  margin-bottom: 8px;
  opacity: 0.8;
}

.form-group input {
  width: 100%;
  padding: 12px;
  background: rgba(11, 15, 26, 0.8);
  border: 2px solid rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  color: white;
  font-size: 14px;
}

.form-btn {
  width: 100%;
  padding: 15px;
  background: linear-gradient(145deg, #00ff88, #00cc6a);
  border: none;
  border-radius: 10px;
  color: #000;
  font-weight: 800;
  font-size: 16px;
  cursor: pointer;
  margin-top: 10px;
}

.form-btn:hover {
  opacity: 0.9;
}

.close-btn {
  width: 100%;
  padding: 12px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 10px;
  color: white;
  font-weight: 600;
  cursor: pointer;
  margin-top: 10px;
}

/* Loading */
.loading {
  text-align: center;
  padding: 40px;
  opacity: 0.7;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 3px solid rgba(255, 255, 255, 0.1);
  border-top-color: #00ff88;
  border-radius: 50%;
  margin: 0 auto 20px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Scrollbar */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}
</style>
</head>

<body>

<canvas id="particles"></canvas>

<header class="app-header">
  <img src="https://crickettv.site/image/api/crickettv.png" alt="CricTV" class="logo">
  <div class="user-section">
    <div class="balance-display" id="userBalance">â‚¹0</div>
    <div class="profile-icon" onclick="openProfile()">ðŸ‘¤</div>
  </div>
</header>

<main class="main-content">
  <div class="matches-section" id="matchesContainer">
    <div class="loading">
      <div class="spinner"></div>
      Loading matches...
    </div>
  </div>
</main>

<div class="modal-overlay" id="profileModal">
  <div class="modal-content">
    <div class="modal-title">My Account</div>
    
    <div class="balance-show">
      <div class="balance-amount" id="modalBalance">â‚¹0</div>
      <div class="balance-label">Available Balance</div>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalBets">0</div>
        <div class="stat-label">Total Bets</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="wonBets">0</div>
        <div class="stat-label">Won Bets</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="lostBets">0</div>
        <div class="stat-label">Lost Bets</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="netProfit">â‚¹0</div>
        <div class="stat-label">Net Profit</div>
      </div>
    </div>
    
    <div class="form-group">
      <label for="userName">Your Name</label>
      <input type="text" id="userName" placeholder="Enter your name">
    </div>
    
    <button class="form-btn" onclick="saveProfile()">Save Profile</button>
    <button class="close-btn" onclick="closeProfile()">Close</button>
  </div>
</div>

<script>
// ==================== PARTICLE SYSTEM ====================
const canvas = document.getElementById('particles');
const ctx = canvas.getContext('2d');
let w, h;

function resize() {
  w = canvas.width = window.innerWidth;
  h = canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

const particles = [];
for (let i = 0; i < 45; i++) {
  particles.push({
    x: Math.random() * w,
    y: Math.random() * h,
    r: Math.random() * 1.4 + 0.4,
    vx: Math.random() * 0.15 + 0.05,
    vy: Math.random() * 0.1 + 0.03,
    a: Math.random() * 0.35 + 0.15
  });
}

function animate() {
  ctx.clearRect(0, 0, w, h);
  particles.forEach(p => {
    p.x += p.vx;
    p.y += p.vy;
    if (p.x > w) p.x = 0;
    if (p.y > h) p.y = 0;
    
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(255,255,255,${p.a})`;
    ctx.fill();
  });
  requestAnimationFrame(animate);
}
animate();

// ==================== USER SYSTEM ====================
let userProfile = null;

function loadUserProfile() {
  const saved = localStorage.getItem('cricTV_user');
  if (saved) {
    userProfile = JSON.parse(saved);
    updateUI();
    return true;
  }
  return false;
}

function createUserProfile() {
  userProfile = {
    name: '',
    balance: 10000,
    bets: [],
    stats: {
      totalBets: 0,
      wonBets: 0,
      lostBets: 0,
      netProfit: 0
    },
    createdAt: new Date().toISOString()
  };
  localStorage.setItem('cricTV_user', JSON.stringify(userProfile));
  updateUI();
  openProfile();
}

function updateUI() {
  if (userProfile) {
    document.getElementById('userBalance').textContent = `â‚¹${userProfile.balance.toLocaleString()}`;
    document.getElementById('modalBalance').textContent = `â‚¹${userProfile.balance.toLocaleString()}`;
    document.getElementById('totalBets').textContent = userProfile.stats.totalBets;
    document.getElementById('wonBets').textContent = userProfile.stats.wonBets;
    document.getElementById('lostBets').textContent = userProfile.stats.lostBets;
    document.getElementById('netProfit').textContent = `â‚¹${userProfile.stats.netProfit.toLocaleString()}`;
    
    if (userProfile.name) {
      document.getElementById('userName').value = userProfile.name;
    }
  }
}

function openProfile() {
  if (!userProfile) {
    createUserProfile();
  } else {
    updateUI();
    document.getElementById('profileModal').classList.add('show');
  }
}

function closeProfile() {
  document.getElementById('profileModal').classList.remove('show');
}

function saveProfile() {
  const name = document.getElementById('userName').value.trim();
  if (!name) {
    alert('Please enter your name');
    return;
  }
  
  userProfile.name = name;
  localStorage.setItem('cricTV_user', JSON.stringify(userProfile));
  
  if (userProfile.balance === 10000) {
    alert(`Welcome ${name}! â‚¹10,000 bonus credited.`);
  }
  
  closeProfile();
}

// ==================== MATCHES LOADING ====================
let matchesData = [];

async function loadMatches() {
  try {
    const API = "https://central.zplay1.in/pb/api/v1/events/matches/4";
    const response = await fetch(API);
    const data = await response.json();
    
    if (data.data && Array.isArray(data.data)) {
      matchesData = data.data;
      renderMatches();
      checkSettlements();
    }
  } catch (error) {
    console.error('Error loading matches:', error);
    document.getElementById('matchesContainer').innerHTML = `
      <div class="loading">
        Failed to load matches. Please try again.
      </div>
    `;
  }
}

function renderMatches() {
  const container = document.getElementById('matchesContainer');
  if (!matchesData.length) {
    container.innerHTML = `<div class="loading">No matches available</div>`;
    return;
  }
  
  let html = '';
  matchesData.forEach(match => {
    // Get runner names
    const runnerNames = {};
    match.runnerNames?.forEach(r => {
      runnerNames[r.SID] = r.RN;
    });
    
    // Generate runners HTML
    let runnersHtml = '';
    match.runners?.forEach(runner => {
      const name = runnerNames[runner.sid] || 'Team';
      const backOdds = runner.ex?.b?.[0]?.p;
      const layOdds = runner.ex?.l?.[0]?.p;
      
      // Check for user's bet
      const userBet = userProfile ? userProfile.bets.find(b => 
        b.eventId == match.event_id && b.runnerId == runner.sid && !b.settled
      ) : null;
      
      runnersHtml += `
        <div class="runner-row">
          <div class="runner-name">${name}</div>
          <div class="odds-display">
            ${backOdds ? `<span class="odds-btn back-odds">${backOdds}</span>` : ''}
            ${layOdds ? `<span class="odds-btn lay-odds">${layOdds}</span>` : ''}
          </div>
        </div>
        ${userBet ? `
          <div style="font-size:11px; padding:5px 10px; background:${userBet.type === 'back' ? 'rgba(0,255,136,0.1)' : 'rgba(255,77,77,0.1)'}; border-radius:6px; margin-top:5px; border:1px solid ${userBet.type === 'back' ? 'rgba(0,255,136,0.2)' : 'rgba(255,77,77,0.2)'}">
            Your ${userBet.type === 'back' ? 'Back' : 'Lay'} Bet: â‚¹${userBet.stake.toLocaleString()} (Win: â‚¹${userBet.potentialWin.toLocaleString()})
          </div>
        ` : ''}
      `;
    });
    
    const status = match.status === 'ACTIVE' ? 'LIVE' : 'UPCOMING';
    const statusClass = match.status === 'ACTIVE' ? 'status-live' : 'status-upcoming';
    
    html += `
      <div class="match-card" onclick="openMatch(${match.event_id})">
        <div class="league-info">${match.league_name || 'Cricket'}</div>
        <div class="match-name">${match.event_name}</div>
        ${runnersHtml}
        <div class="status-badge ${statusClass}">${status}</div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function openMatch(matchId) {
  window.location.href = `match.html?eventId=${matchId}`;
}

// ==================== BET SETTLEMENT ====================
function checkSettlements() {
  if (!userProfile || !matchesData.length) return;
  
  let updated = false;
  
  userProfile.bets.forEach(bet => {
    if (!bet.settled) {
      const match = matchesData.find(m => m.event_id == bet.eventId);
      if (match) {
        const runner = match.runners?.find(r => r.sid == bet.runnerId);
        if (runner && runner.s === "WINNER") {
          // Settle bet
          bet.settled = true;
          
          if (bet.type === 'back') {
            // Back bet won
            const winnings = bet.stake * bet.odds;
            userProfile.balance += winnings;
            bet.result = 'WIN';
            bet.winnings = winnings;
            userProfile.stats.wonBets++;
            userProfile.stats.netProfit += (winnings - bet.stake);
          } else if (bet.type === 'lay') {
            // Lay bet lost
            bet.result = 'LOSE';
            userProfile.stats.lostBets++;
            userProfile.stats.netProfit -= bet.stake;
          }
          updated = true;
        } else if (runner && runner.s === "LOSER" && bet.type === 'lay') {
          // Lay bet won
          userProfile.balance += bet.stake;
          bet.settled = true;
          bet.result = 'WIN';
          bet.winnings = bet.stake;
          userProfile.stats.wonBets++;
          userProfile.stats.netProfit += bet.stake;
          updated = true;
        }
      }
    }
  });
  
  if (updated) {
    userProfile.stats.totalBets = userProfile.bets.length;
    localStorage.setItem('cricTV_user', JSON.stringify(userProfile));
    updateUI();
    renderMatches();
  }
}

// ==================== INITIALIZATION ====================
window.addEventListener('load', () => {
  if (!loadUserProfile()) {
    createUserProfile();
  }
  
  loadMatches();
  setInterval(checkSettlements, 5000);
  setInterval(loadMatches, 30000);
});
</script>
</body>
</html>
