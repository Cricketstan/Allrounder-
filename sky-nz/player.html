<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css"/>

  <style>
    body, html {
      margin:0;
      padding:0;
      background:black;
      height:100%;
    }
    .shaka-video-container {
      width:100%;
      height:100%;
    }
    video {
      width:100%;
      height:100%;
      background:black;
    }
  </style>
</head>

<body>

<div class="shaka-video-container" data-shaka-player>
  <video autoplay playsinline></video>
</div>

<script>
const JSON_URL = "https://sky-nz.dillzycreations.workers.dev/output";

function getParam(name) {
  return new URLSearchParams(window.location.search).get(name);
}

async function init() {
  const id = getParam("id");
  if (!id) return alert("No channel selected");

  const res = await fetch(JSON_URL);
  const data = await res.json();
  const ch = data[id];

  if (!ch) return alert("Invalid channel");

  shaka.polyfill.installAll();
  if (!shaka.Player.isBrowserSupported()) {
    alert("Browser not supported");
    return;
  }

  const video = document.querySelector("video");
  const container = document.querySelector(".shaka-video-container");

  const player = new shaka.Player(video);
  const ui = new shaka.ui.Overlay(player, container, video);

  const clearKeys = {};
  clearKeys[ch.kid] = ch.key;

  player.configure({
    drm: { clearKeys }
  });

  player.getNetworkingEngine().registerRequestFilter((type, request) => {
    request.headers['Referer'] = 'https://www.jiotv.com/';
    request.headers['User-Agent'] =
      "plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6";
  });

  try {
    await player.load(ch.mpd);
    console.log("Playing:", ch.name);
  } catch (e) {
    console.error(e);
    alert("Playback error");
  }
}

init();
</script>

</body>
</html>
