<!DOCTYPE html>
<html lang="en">
<head>
  <title>Fox Cricket</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <meta name="referrer" content="no-referrer"/>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css"/>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.polyfilled.js"></script>

  <style>
    body {
      background-color: #000;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    html, body {
      height: 100%;
      width: 100%;
    }
    .video-container {
      position: relative;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
    }
    .plyr {
      height: 100%;
      width: 100%;
    }

    #capture-preview {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
      z-index: 10000;
      display: none;
      max-width: 85%;
      max-height: 85%;
      border: 1px solid rgba(255, 255, 255, 0.1);
      animation: fadeInScale 0.3s ease-out forwards;
      pointer-events: none;
    }

    @keyframes fadeInScale {
      to {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }

    #capture-preview.show {
      display: block;
      opacity: 0;
    }

    #capture-preview .preview-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      color: #4CAF50;
      font-family: Arial, sans-serif;
      font-size: 16px;
      font-weight: 600;
    }

    #capture-preview .image-wrapper {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    #capture-preview img {
      max-width: 100%;
      max-height: 65vh;
      display: block;
      border-radius: 10px;
    }

    #capture-preview .info {
      color: #888;
      text-align: center;
      margin-top: 16px;
      font-family: Arial, sans-serif;
      font-size: 13px;
    }

    .plyr__controls button[data-plyr="capture"] svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }
  </style>
</head>

<body>

<div class="video-container">
  <video autoplay playsinline muted id="player" controls preload="metadata"></video>
</div>

<div id="capture-preview">
  <div class="preview-header">âœ” Frame Captured</div>
  <div class="image-wrapper">
    <img id="captured-image">
  </div>
  <div class="info">Downloaded automatically</div>
</div>

<script>
function captureFrame() {
  const video = document.getElementById("player");
  if (!video || !video.videoWidth) return;

  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  canvas.toBlob(blob => {
    const url = URL.createObjectURL(blob);

    // REAL USER-GESTURE DOWNLOAD FIX
    const a = document.createElement("a");
    a.href = url;
    a.download = `frame-${Date.now()}.png`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    // Premium preview
    const preview = document.getElementById("capture-preview");
    const img = document.getElementById("captured-image");
    img.src = url;
    preview.classList.add("show");

    setTimeout(() => {
      preview.classList.remove("show");
      URL.revokeObjectURL(url);
    }, 2500);
  }, "image/png");
}

document.addEventListener("DOMContentLoaded", function () {
  const params = new URLSearchParams(window.location.search);
  const streamUrl = params.get("url") || "https://rumble.com/live-hls-dvr/6z4aec/playlist.m3u8?level=1";

  const video = document.getElementById("player");

  if (Hls.isSupported()) {
    const hls = new Hls();
    hls.loadSource(streamUrl);
    hls.attachMedia(video);

    hls.on(Hls.Events.MANIFEST_PARSED, (_, data) => {
      const qualities = data.levels.map(l => l.height).sort((a,b)=>b-a);

      const player = new Plyr(video, {
        autoplay: true,
        controls: ['play','progress','current-time','mute','volume','settings','fullscreen'],
        quality: {
          default: qualities[0],
          options: qualities,
          forced: true,
          onChange: q => {
            hls.levels.forEach((l,i)=>{ if(l.height===q) hls.currentLevel=i; });
          }
        }
      });

      player.on("ready", () => addCaptureButton());
    });
  } else {
    video.src = streamUrl;
    new Plyr(video);
  }
});

function addCaptureButton() {
  const controls = document.querySelector(".plyr__controls");
  if (!controls) return;

  const btn = document.createElement("button");
  btn.className = "plyr__controls__item plyr__control";
  btn.setAttribute("type","button");
  btn.innerHTML = `
    <svg viewBox="0 0 24 24">
      <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2z"/>
    </svg>
  `;

  btn.onclick = captureFrame;

  const fs = controls.querySelector('[data-plyr="fullscreen"]');
  if (fs) controls.insertBefore(btn, fs);
  else controls.appendChild(btn);
}
</script>

</body>
</html>
