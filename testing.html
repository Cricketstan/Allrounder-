<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kick Stream</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Plyr.js CSS -->
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  
  <!-- HLS.js for HLS support -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>
  
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #000;
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    }
    
    #container {
      width: 100%;
      height: 100%;
      position: relative;
    }
    
    #player {
      width: 100%;
      height: 100%;
    }
    
    /* Custom quality menu */
    #qualityMenu {
      position: absolute;
      right: 70px;
      bottom: 80px;
      background: rgba(0, 0, 0, 0.95);
      padding: 12px 0;
      border-radius: 8px;
      display: none;
      z-index: 9999;
      min-width: 120px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .quality-item {
      padding: 10px 16px;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .quality-item:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    
    .quality-item.active {
      color: #00e054;
      background: rgba(0, 224, 84, 0.1);
    }
    
    /* Custom quality button in Plyr controls */
    .plyr__menu {
      display: flex;
      align-items: center;
    }
    
    .plyr__menu__item {
      margin-right: 10px;
    }
    
    .quality-btn {
      background: none;
      border: none;
      color: inherit;
      font-size: 14px;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 4px;
    }
    
    .quality-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    /* Loading indicator */
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 18px;
      z-index: 1000;
    }
    
    /* Error message */
    .error {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #ff5555;
      text-align: center;
      padding: 20px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 8px;
      z-index: 1000;
    }
  </style>
</head>

<body>
  <div id="container">
    <div id="player"></div>
    <div id="qualityMenu"></div>
    <div id="loading" class="loading">Loading stream...</div>
    <div id="error" class="error" style="display: none;"></div>
  </div>

  <!-- Plyr.js -->
  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

  <script>
    (async function() {
      // Get username from URL parameter or use default
      const urlParams = new URLSearchParams(location.search);
      const username = urlParams.get("id") || "maxholloway";
      
      const container = document.getElementById('container');
      const playerEl = document.getElementById('player');
      const qualityMenu = document.getElementById('qualityMenu');
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      
      let streamUrl = "";
      let qualities = [];
      let currentQuality = "";
      let player = null;
      let hls = null;

      // Function to show error
      function showError(message) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        loadingEl.style.display = 'none';
      }

      // Function to hide loading
      function hideLoading() {
        loadingEl.style.display = 'none';
      }

      // Fetch stream URL from Kick API
      try {
        loadingEl.textContent = "Fetching stream data...";
        const res = await fetch(`https://kick.com/api/v2/channels/${username}`);
        
        if (!res.ok) {
          throw new Error(`API request failed: ${res.status}`);
        }
        
        const data = await res.json();
        
        if (!data.playback_url) {
          throw new Error("No stream URL available. The streamer might be offline.");
        }
        
        streamUrl = data.playback_url;
      } catch (e) {
        console.error("Kick API error:", e);
        showError(`Failed to load stream: ${e.message}`);
        return;
      }

      // Function to parse available qualities from HLS playlist
      async function getQualities() {
        try {
          const response = await fetch(streamUrl);
          const text = await response.text();
          
          // Parse HLS manifest for quality variants
          const regex = /#EXT-X-STREAM-INF:.*?RESOLUTION=(\d+x\d+).*?\n(.*?)(?=\n#|\n$)/gs;
          
          let list = [];
          let match;
          
          // Add "Auto" option first
          list.push({
            label: "Auto",
            url: streamUrl,
            resolution: "Auto"
          });
          
          // Parse all quality variants
          while ((match = regex.exec(text)) !== null) {
            const resolution = match[1];
            const url = new URL(match[2].trim(), streamUrl).href;
            const height = resolution.split('x')[1];
            
            list.push({
              label: `${height}p`,
              url: url,
              resolution: resolution
            });
          }
          
          // Sort by quality (highest first)
          list.sort((a, b) => {
            if (a.label === "Auto") return -1;
            if (b.label === "Auto") return 1;
            return parseInt(b.label) - parseInt(a.label);
          });
          
          return list;
        } catch (e) {
          console.error("Error parsing qualities:", e);
          return [{
            label: "Auto",
            url: streamUrl,
            resolution: "Auto"
          }];
        }
      }

      // Function to create quality menu
      function createQualityMenu(qualitiesList) {
        qualityMenu.innerHTML = '';
        
        qualitiesList.forEach(q => {
          const item = document.createElement('div');
          item.className = `quality-item ${currentQuality === q.label ? 'active' : ''}`;
          item.textContent = q.label;
          item.dataset.quality = q.label;
          
          item.onclick = () => {
            // Update active state
            document.querySelectorAll('.quality-item').forEach(el => {
              el.classList.remove('active');
            });
            item.classList.add('active');
            
            // Switch quality
            switchQuality(q);
            qualityMenu.style.display = 'none';
          };
          
          qualityMenu.appendChild(item);
        });
      }

      // Function to switch video quality
      function switchQuality(quality) {
        if (!player || !hls) return;
        
        currentQuality = quality.label;
        
        if (quality.label === "Auto") {
          // For auto quality, load the main stream URL
          hls.loadSource(streamUrl);
        } else {
          // Load specific quality stream
          hls.loadSource(quality.url);
        }
        
        hls.startLoad();
        player.play();
        
        // Update quality button text
        const qualityBtn = document.querySelector('.plyr__quality');
        if (qualityBtn) {
          qualityBtn.textContent = `Quality: ${currentQuality}`;
        }
      }

      // Function to add custom quality button to Plyr controls
      function addQualityButton() {
        // Wait for Plyr controls to be rendered
        setTimeout(() => {
          const controls = document.querySelector('.plyr__controls');
          if (!controls) return;
          
          // Check if button already exists
          if (document.querySelector('.plyr__quality')) return;
          
          // Create quality button
          const qualityBtn = document.createElement('button');
          qualityBtn.className = 'plyr__controls__item plyr__control plyr__quality';
          qualityBtn.type = 'button';
          qualityBtn.textContent = `Quality: ${currentQuality || 'Auto'}`;
          
          qualityBtn.onclick = (e) => {
            e.stopPropagation();
            // Toggle quality menu visibility
            qualityMenu.style.display = qualityMenu.style.display === 'block' ? 'none' : 'block';
          };
          
          // Insert before the settings button (if exists) or at the end
          const settingsBtn = document.querySelector('.plyr__menu');
          if (settingsBtn) {
            controls.insertBefore(qualityBtn, settingsBtn);
          } else {
            controls.appendChild(qualityBtn);
          }
        }, 500);
      }

      // Initialize player with HLS stream
      function initPlayer() {
        // Check if HLS is natively supported
        const video = document.createElement('video');
        const canPlayHls = video.canPlayType('application/vnd.apple.mpegurl') ||
                          video.canPlayType('application/x-mpegURL');
        
        // Create video element for Plyr
        const videoElement = document.createElement('video');
        videoElement.id = 'plyr-video';
        videoElement.setAttribute('playsinline', '');
        videoElement.setAttribute('controls', '');
        
        // Create source element
        const source = document.createElement('source');
        source.src = streamUrl;
        source.type = 'application/x-mpegURL';
        
        videoElement.appendChild(source);
        playerEl.appendChild(videoElement);
        
        // Initialize Plyr player
        player = new Plyr(videoElement, {
          autoplay: true,
          controls: [
            'play-large',
            'play',
            'progress',
            'current-time',
            'mute',
            'volume',
            'settings',
            'pip',
            'airplay',
            'fullscreen'
          ],
          settings: ['captions', 'quality', 'speed', 'loop'],
          hideControls: false,
          clickToPlay: true,
          disableContextMenu: false,
          loadSprite: false,
          iconPrefix: 'plyr',
          quality: {
            default: 0,
            options: [0], // Will be updated after fetching qualities
            forced: true,
            onChange: (quality) => {
              // This will be handled by our custom quality switcher
            }
          }
        });
        
        // If HLS is not natively supported, use HLS.js
        if (!canPlayHls && Hls.isSupported()) {
          hls = new Hls({
            enableWorker: true,
            lowLatencyMode: true,
            backBufferLength: 90
          });
          
          hls.loadSource(streamUrl);
          hls.attachMedia(videoElement);
          
          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            hideLoading();
            addQualityButton();
          });
          
          hls.on(Hls.Events.ERROR, (event, data) => {
            console.error('HLS error:', data);
            if (data.fatal) {
              switch(data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR:
                  hls.startLoad();
                  break;
                case Hls.ErrorTypes.MEDIA_ERROR:
                  hls.recoverMediaError();
                  break;
                default:
                  showError('Stream playback error. Trying to reconnect...');
                  hls.destroy();
                  break;
              }
            }
          });
        } else if (canPlayHls) {
          // Native HLS support (Safari)
          videoElement.addEventListener('loadedmetadata', () => {
            hideLoading();
            addQualityButton();
          });
        } else {
          showError('Your browser does not support HLS streaming.');
          return;
        }
        
        // Handle player events
        player.on('ready', () => {
          hideLoading();
        });
        
        player.on('error', (event) => {
          console.error('Player error:', event.detail);
          showError('Playback error occurred. Please refresh the page.');
        });
        
        // Hide quality menu when clicking elsewhere
        document.addEventListener('click', (e) => {
          if (!qualityMenu.contains(e.target) && !e.target.closest('.plyr__quality')) {
            qualityMenu.style.display = 'none';
          }
        });
        
        // Handle keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          // Space bar to play/pause
          if (e.code === 'Space' && e.target === document.body) {
            e.preventDefault();
            player.togglePlay();
          }
          
          // 'M' to mute/unmute
          if (e.code === 'KeyM' && e.target === document.body) {
            e.preventDefault();
            player.muted = !player.muted;
          }
          
          // 'F' for fullscreen
          if (e.code === 'KeyF' && e.target === document.body) {
            e.preventDefault();
            player.fullscreen.toggle();
          }
        });
      }

      // Initialize the application
      async function init() {
        // Get available qualities
        qualities = await getQualities();
        
        if (qualities.length === 0) {
          showError('No quality options available for this stream.');
          return;
        }
        
        // Set default quality to Auto
        currentQuality = "Auto";
        
        // Create quality menu
        createQualityMenu(qualities);
        
        // Initialize player
        initPlayer();
        
        // Background hit counter (unchanged from original)
        fetch("https://hit-counter-7fvw.vercel.app/api/hit?key=hindi", {
          method: "GET",
          mode: "no-cors",
          keepalive: true
        });
      }

      // Start the app
      init();
    })();
  </script>
</body>
</html>
