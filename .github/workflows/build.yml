name: Build Fully Static Pages

on:
  push:
    paths:
      - api/page.json
      - template/index.html
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate static pages safely
        run: |
          python3 << 'EOF'
import json, os, shutil, datetime

SITE = "https://crickettv.site"
HOME_DIR = "home"
SAFE_DIRS = {"wpl", "assets", "images"}
SEO_PAGES = ["https://crickettv.site/cricket-tv-hd"]

def render_list(items):
    if not items:
        return ""
    return "<ul>" + "".join(f"<li>{i}</li>" for i in items) + "</ul>"

with open("api/page.json", "r", encoding="utf-8") as f:
    data = json.load(f)

with open("template/index.html", "r", encoding="utf-8") as f:
    template = f.read()

os.makedirs(HOME_DIR, exist_ok=True)
valid_ids = {p["id"] for p in data["pages"]}

# SAFE CLEANUP
for name in os.listdir(HOME_DIR):
    path = os.path.join(HOME_DIR, name)
    if not os.path.isdir(path):
        continue
    if name in SAFE_DIRS:
        continue
    if name not in valid_ids and os.path.exists(os.path.join(path, "index.html")):
        shutil.rmtree(path)

sitemap_urls = []
index_pages = []

for page in data["pages"]:
    pid = page["id"]
    out_dir = f"{HOME_DIR}/{pid}"
    os.makedirs(out_dir, exist_ok=True)

    streams = page.get("streams", [])
    buttons = [
        f'<button data-src="{s["src"]}">{s["name"]}</button>'
        for s in streams
    ]

    content = page.get("content", {})
    team1 = page["match"]["team1"]
    team2 = page["match"]["team2"]

    html = (
        template
        .replace("{{META_TITLE}}", page["seo"]["meta_title"])
        .replace("{{META_DESCRIPTION}}", page["seo"]["meta_description"])
        .replace("{{CANONICAL}}", page["seo"]["canonical"])
        .replace("{{TITLE}}", page["match"]["title"])
        .replace("{{TEAM1_NAME}}", team1)
        .replace("{{TEAM2_NAME}}", team2)
        .replace("{{DESCRIPTION}}", content.get("overview", ""))
        .replace("{{DEFAULT_IFRAME}}", streams[0]["src"] if streams else "")
        .replace("{{SERVER_BUTTONS}}", "\n".join(buttons))
    )

    with open(f"{out_dir}/index.html", "w", encoding="utf-8") as f:
        f.write(html)

    sitemap_urls.append(page["seo"]["canonical"])
    index_pages.append({"id": pid, "url": page["seo"]["canonical"]})

# ADD SEO PAGE
sitemap_urls.extend(SEO_PAGES)
sitemap_urls = sorted(set(sitemap_urls))

today = datetime.date.today().isoformat()
sitemap = [
    '<?xml version="1.0" encoding="UTF-8"?>',
    '<urlset xmlns="https://www.sitemaps.org/schemas/sitemap/0.9">'
]

for url in sitemap_urls:
    sitemap.append(f"""  <url>
    <loc>{url}</loc>
    <lastmod>{today}</lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.7</priority>
  </url>""")

sitemap.append("</urlset>")

with open("sitemap.xml", "w", encoding="utf-8") as f:
    f.write("\n".join(sitemap))

with open("home/id.json", "w", encoding="utf-8") as f:
    json.dump({
        "site": SITE,
        "updated_at": datetime.datetime.utcnow().isoformat() + "Z",
        "count": len(index_pages),
        "pages": index_pages
    }, f, indent=2)
EOF

      - name: Commit & push changes
        run: |
          git config user.name "static-pages-bot"
          git config user.email "bot@github.com"
          git add home sitemap.xml
          git diff --cached --quiet || git commit -m "Sync static pages & sitemap"
          git push
