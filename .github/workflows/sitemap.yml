name: Sitemap Generator

on:
  workflow_dispatch:
  push:
    paths:
      - home/id.json
  schedule:
    - cron: "*/15 * * * *"

permissions:
  contents: write

jobs:
  sitemap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Debug trigger
        run: echo "Workflow triggered successfully"

      - name: Generate sitemap.xml
        run: |
          python3 << 'EOF'
          import json
          from datetime import date

          ID_JSON = "home/id.json"

          EXTRA_URLS = [
              "https://crickettv.site/",
              "https://crickettv.site/wpl",
              "https://crickettv.site/cricket-tv-hd"
          ]

          today = date.today().isoformat()

          with open(ID_JSON, "r", encoding="utf-8") as f:
              data = json.load(f)

          urls = EXTRA_URLS[:]
          for p in data.get("pages", []):
              if "url" in p:
                  urls.append(p["url"])

          sitemap = [
              '<?xml version="1.0" encoding="UTF-8"?>',
              '<urlset xmlns="https://www.sitemaps.org/schemas/sitemap/0.9">'
          ]

          for u in sorted(set(urls)):
              sitemap += [
                  "  <url>",
                  f"    <loc>{u}</loc>",
                  f"    <lastmod>{today}</lastmod>",
                  "    <changefreq>weekly</changefreq>",
                  "    <priority>0.7</priority>",
                  "  </url>"
              ]

          sitemap.append("</urlset>")

          with open("sitemap.xml", "w") as f:
              f.write("\n".join(sitemap))
          EOF

      - name: Commit sitemap
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add sitemap.xml
          git commit -m "Auto update sitemap" || echo "No changes"
          git push
