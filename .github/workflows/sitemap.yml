name: Auto Generate Sitemap

on:
  workflow_dispatch:
  push:
    paths:
      - home/id.json
  schedule:
    - cron: "*/15 * * * *"

permissions:
  contents: write

jobs:
  sitemap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate sitemap.xml
        run: |
          python3 << 'EOF'
          import json
          from datetime import date
          from urllib.parse import urlparse

          ID_JSON_PATH = "home/id.json"
          BASE_DOMAIN = "https://allrounderlive.in"

          # Only pages you want forced in sitemap
          EXTRA_URLS = [
              f"{BASE_DOMAIN}/",
              f"{BASE_DOMAIN}/live-match",
              f"{BASE_DOMAIN}/t20-worldcup",
              f"{BASE_DOMAIN}/wpl"
          ]

          today = date.today().isoformat()

          with open(ID_JSON_PATH, "r", encoding="utf-8") as f:
              data = json.load(f)

          urls = EXTRA_URLS[:]

          for page in data.get("pages", []):
              if "url" not in page:
                  continue

              raw_url = page["url"].strip()

              # Force rewrite to your domain
              if raw_url.startswith("http"):
                  parsed = urlparse(raw_url)
                  clean_url = f"{BASE_DOMAIN}{parsed.path}"
              else:
                  clean_url = f"{BASE_DOMAIN}{raw_url}"

              urls.append(clean_url)

          sitemap = [
              '<?xml version="1.0" encoding="UTF-8"?>',
              '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">'
          ]

          for u in sorted(set(urls)):
              if u == f"{BASE_DOMAIN}/":
                  priority = "1.0"
              elif u == f"{BASE_DOMAIN}/t20-worldcup":
                  priority = "0.8"
              elif u == f"{BASE_DOMAIN}/live-match":
                  priority = "0.8"
              else:
                  priority = "0.7"

              sitemap.extend([
                  "  <url>",
                  f"    <loc>{u}</loc>",
                  f"    <lastmod>{today}</lastmod>",
                  "    <changefreq>weekly</changefreq>",
                  f"    <priority>{priority}</priority>",
                  "  </url>"
              ])

          sitemap.append("</urlset>")

          with open("sitemap.xml", "w", encoding="utf-8") as f:
              f.write("\n".join(sitemap))

          print("âœ… sitemap.xml generated ONLY for allrounderlive.in")
          EOF

      - name: Commit and push sitemap.xml
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add sitemap.xml
          git commit -m "Auto update sitemap.xml" || echo "No changes"
          git push
