name: Auto Generate Sitemap

on:
  workflow_dispatch:
  push:
    paths:
      - home/id.json
  schedule:
    - cron: "*/15 * * * *"

permissions:
  contents: write

jobs:
  sitemap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate sitemap.xml
        run: |
          python3 << 'EOF'
          import json
          from datetime import date

          ID_JSON_PATH = "home/id.json"

          BASE_DOMAIN = "https://allrounderlive.in"

          EXTRA_URLS = [
              f"{BASE_DOMAIN}/",
              f"{BASE_DOMAIN}/cricket-tv-hd",
              f"{BASE_DOMAIN}/wpl"
          ]

          today = date.today().isoformat()

          with open(ID_JSON_PATH, "r", encoding="utf-8") as f:
              data = json.load(f)

          urls = EXTRA_URLS[:]

          for page in data.get("pages", []):
              if "url" in page:
                  # ensure all URLs are on new domain
                  if page["url"].startswith("http"):
                      urls.append(page["url"])
                  else:
                      urls.append(f"{BASE_DOMAIN}{page['url']}")

          sitemap = [
              '<?xml version="1.0" encoding="UTF-8"?>',
              '<urlset xmlns="https://www.sitemaps.org/schemas/sitemap/0.9">'
          ]

          for u in sorted(set(urls)):
              if u == f"{BASE_DOMAIN}/":
                  priority = "1.0"
              elif u == f"{BASE_DOMAIN}/cricket-tv-hd":
                  priority = "0.9"
              elif u == f"{BASE_DOMAIN}/wpl":
                  priority = "0.8"
              else:
                  priority = "0.7"

              sitemap.extend([
                  "  <url>",
                  f"    <loc>{u}</loc>",
                  f"    <lastmod>{today}</lastmod>",
                  "    <changefreq>weekly</changefreq>",
                  f"    <priority>{priority}</priority>",
                  "  </url>"
              ])

          sitemap.append("</urlset>")

          with open("sitemap.xml", "w", encoding="utf-8") as f:
              f.write("\n".join(sitemap))

          print("âœ… sitemap.xml generated successfully for allrounderlive.in")
          EOF

      - name: Commit and push sitemap.xml
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add sitemap.xml
          git commit -m "Auto update sitemap.xml" || echo "No changes"
          git push
