name: WPL VIDEO

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Build WPL JSON & pages
        run: |
          python3 << 'EOF'
          import requests, os, json

          API = "https://wpl-video.cricketstream745.workers.dev/"
          MAX = 50

          JSON_FILE = "api/wpl.json"
          WPL_DIR = "wpl"
          TEMPLATE = "template/wpl.html"

          os.makedirs("api", exist_ok=True)
          os.makedirs(WPL_DIR, exist_ok=True)

          data = requests.get(API, timeout=20).json()
          items = data["items"][:MAX]

          tpl = open(TEMPLATE, "r", encoding="utf-8").read()

          keep = set()
          json_items = []

          for item in items:
              vid = item["video_id"]
              filename = f"{vid}.html"
              keep.add(filename)

              page_url = f"https://crickettv.site/wpl/{filename}"

              # JSON ENTRY
              json_items.append({
                  "title": item["title"],
                  "thumbnail": item["thumbnail"],
                  "publish_date": item["published"],
                  "url": page_url
              })

              # PAGE
              html = tpl \
                .replace("{{TITLE}}", item["title"]) \
                .replace("{{PLAYER}}", item["player"])

              with open(f"{WPL_DIR}/{filename}", "w", encoding="utf-8") as f:
                  f.write(html)

          # DELETE OLD FILES
          for f in os.listdir(WPL_DIR):
              if f.endswith(".html") and f not in keep:
                  os.remove(f"{WPL_DIR}/{f}")

          # WRITE JSON
          with open(JSON_FILE, "w", encoding="utf-8") as jf:
              json.dump({
                  "updated_at": data.get("updated_at"),
                  "items": json_items
              }, jf, indent=2)

          print("WPL pages:", len(keep))
          EOF

      - name: Commit & push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add api wpl
          git commit -m "Auto update WPL (JSON + pages, max 50)" || exit 0
          git push
