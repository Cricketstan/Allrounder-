name: WPL VIDEO

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build WPL JSON, pages & sitemap
        run: |
          python3 << 'EOF'
          import requests, os, json
          from datetime import datetime
          from xml.etree.ElementTree import Element, SubElement, ElementTree

          API = "https://wpl-video.cricketstream745.workers.dev/"
          MAX = 50
          SITEMAP_LIMIT = 5

          JSON_FILE = "api/wpl.json"
          WPL_DIR = "wpl"
          TEMPLATE = "template/wpl.html"
          SITEMAP_FILE = "sitemap.xml"
          SITE = "https://crickettv.site"

          os.makedirs("api", exist_ok=True)
          os.makedirs(WPL_DIR, exist_ok=True)

          data = requests.get(API, timeout=20).json()
          items = data.get("items", [])[:MAX]

          tpl = open(TEMPLATE, "r", encoding="utf-8").read()

          keep = set()
          json_items = []

          for item in items:
              vid = item.get("video_id")
              if not vid:
                  continue

              filename = f"{vid}.html"
              keep.add(filename)
              page_url = f"{SITE}/wpl/{filename}"

              published_iso = item.get("published")
              if published_iso:
                  published_iso = published_iso.replace("Z", "")
              else:
                  published_iso = datetime.utcnow().isoformat()

              json_items.append({
                  "title": item.get("title"),
                  "thumbnail": item.get("thumbnail"),
                  "video_id": vid,
                  "duration": item.get("duration"),
                  "published_iso": published_iso,
                  "url": page_url
              })

              html = tpl \
                .replace("{{TITLE}}", item.get("title", "")) \
                .replace("{{PLAYER}}", item.get("player", "")) \
                .replace("{{SCHEMA_THUMBNAIL}}", item.get("thumbnail", "")) \
                .replace("{{SCHEMA_UPLOAD_DATE}}", published_iso) \
                .replace("{{CANONICAL}}", page_url)

              with open(f"{WPL_DIR}/{filename}", "w", encoding="utf-8") as f:
                  f.write(html)

          for f in os.listdir(WPL_DIR):
              if f.endswith(".html") and f not in keep:
                  os.remove(f"{WPL_DIR}/{f}")

          with open(JSON_FILE, "w", encoding="utf-8") as jf:
              json.dump({
                  "updated_at": data.get("updated_at"),
                  "count": len(json_items),
                  "items": json_items
              }, jf, indent=2, ensure_ascii=False)

          urlset = Element("urlset")
          urlset.set("xmlns", "http://www.sitemaps.org/schemas/sitemap/0.9")

          for item in json_items[:SITEMAP_LIMIT]:
              url = SubElement(urlset, "url")
              SubElement(url, "loc").text = item["url"]
              SubElement(url, "lastmod").text = item["published_iso"].split("T")[0]
              SubElement(url, "changefreq").text = "daily"
              SubElement(url, "priority").text = "0.9"

          ElementTree(urlset).write(
              SITEMAP_FILE,
              encoding="utf-8",
              xml_declaration=True
          )

          print("WPL pages:", len(keep))
          print("Sitemap updated with latest 5 videos")
          EOF

      - name: Commit & push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add api wpl sitemap.xml
          git commit -m "Auto update WPL videos + sitemap" || exit 0
          git push
