name: WPL VIDEO

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build WPL JSON, pages & update sitemap
        run: |
          python3 << 'EOF'
          import requests, os, json
          from datetime import datetime
          import xml.etree.ElementTree as ET

          API = "https://wpl-video.cricketstream745.workers.dev/"
          MAX = 100
          WPL_LIMIT = 5

          SITE = "https://crickettv.site"
          JSON_FILE = "api/wpl.json"
          WPL_DIR = "wpl"
          TEMPLATE = "template/wpl.html"
          SITEMAP_FILE = "sitemap.xml"

          os.makedirs("api", exist_ok=True)
          os.makedirs(WPL_DIR, exist_ok=True)

          data = requests.get(API, timeout=20).json()
          items = data.get("items", [])[:MAX]

          tpl = open(TEMPLATE, "r", encoding="utf-8").read()

          keep = set()
          json_items = []

          # ---------- BUILD PAGES + JSON ----------
          for item in items:
              vid = item.get("video_id")
              if not vid:
                  continue

              filename = f"{vid}.html"
              keep.add(filename)

              page_url = f"{SITE}/wpl/{filename}"

              published_iso = item.get("published")
              if published_iso:
                  published_iso = published_iso.replace("Z", "")
              else:
                  published_iso = datetime.utcnow().isoformat()

              json_items.append({
                  "title": item.get("title"),
                  "thumbnail": item.get("thumbnail"),
                  "video_id": vid,
                  "duration": item.get("duration"),
                  "published_iso": published_iso,
                  "url": page_url
              })

              html = tpl \
                .replace("{{TITLE}}", item.get("title", "")) \
                .replace("{{PLAYER}}", item.get("player", "")) \
                .replace("{{SCHEMA_THUMBNAIL}}", item.get("thumbnail", "")) \
                .replace("{{SCHEMA_UPLOAD_DATE}}", published_iso) \
                .replace("{{CANONICAL}}", page_url)

              with open(f"{WPL_DIR}/{filename}", "w", encoding="utf-8") as f:
                  f.write(html)

          # ---------- CLEAN OLD WPL FILES ----------
          for f in os.listdir(WPL_DIR):
              if f.endswith(".html") and f not in keep:
                  os.remove(f"{WPL_DIR}/{f}")

          # ---------- WRITE JSON ----------
          with open(JSON_FILE, "w", encoding="utf-8") as jf:
              json.dump({
                  "updated_at": data.get("updated_at"),
                  "count": len(json_items),
                  "items": json_items
              }, jf, indent=2, ensure_ascii=False)

          
      - name: Commit & push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add api wpl sitemap.xml
          git commit -m "Auto update WPL pages + safe sitemap merge" || exit 0
          git push
